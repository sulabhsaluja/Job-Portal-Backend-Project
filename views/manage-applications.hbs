<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Applications</title>
  <link rel="stylesheet" href="/css/styles.css" />
  <style>
  .applications-list {
    margin-top: 100px; /* adjust as needed */
    padding: 20px;
  }

  .applications-list ul li {
    margin-bottom: 20px;
    border-bottom: 1px solid #ccc;
    padding-bottom: 10px;
  }
</style>

</head>
<body>

  {{#if user}}
    {{#if (eq user.role "employer")}}
      <header>
        <div class="logo"><a href="/">InternSpot</a></div>
        <nav class="nav-links">
          <a href="/">Home</a>
          <a href="/post-job">Post Job</a>
          <a href="/manage-applications">Manage Applications</a>
          <a href="/logout">Logout</a>
        </nav>
      </header>

      <section class="applications-list">
        <h1>Manage Applications</h1>

        {{#each jobs}}
          <div class="job">
            <h2>{{this.title}} - {{this.company}}</h2>
            <p>{{this.location}}</p>
            <ul>
              {{#each this.applications}}
                <li>
                  <p><strong>Applicant:</strong> {{this.user.username}}</p>
                  <p><strong>Email:</strong> {{this.user.email}}</p>
                  <p><strong>Cover Letter:</strong> {{this.coverLetter}}</p>
                  <p><strong>Status:</strong> {{this.status}}</p>

                  <form onsubmit="return updateApplicationStatus(this)">
                    <input type="hidden" name="jobId" value="{{../_id}}">
                    <input type="hidden" name="applicantId" value="{{this.user._id}}">

                    <select name="status">
                      <option value="pending" {{#if (eq this.status "pending")}}selected{{/if}}>Pending</option>
                      <option value="accepted" {{#if (eq this.status "accepted")}}selected{{/if}}>Accepted</option>
                      <option value="rejected" {{#if (eq this.status "rejected")}}selected{{/if}}>Rejected</option>
                    </select>
                    <button type="submit">Update Status</button>
                  </form>
                </li>
              {{/each}}
            </ul>
          </div>
        {{else}}
          <p>No applications found for this job.</p>
        {{/each}}
      </section>
    {{else}}
      <p>You do not have permission to view this page.</p>
    {{/if}}
  {{else}}
    <p>You must be logged in to view this page.</p>
  {{/if}}

  <script>
    function updateApplicationStatus(form) {
      const jobId = form.elements.jobId.value;
      const applicantId = form.elements.applicantId.value;
      const status = form.elements.status.value;

      fetch('/update-application-status', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ jobId, applicantId, status })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          form.closest('li').remove();
        } else {
          alert('Update failed: ' + data.message);
        }
      })
      .catch(err => {
        console.error('Error:', err);
        alert('Something went wrong.');
      });

      return false;
    }
  </script>

</body>
</html>

